---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getSortedPosts, getTotalPages, paginatePosts } from "../../../lib/posts";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const posts = await getSortedPosts();
  const totalPages = getTotalPages(posts);

  if (totalPages <= 1) return [];

  return Array.from({ length: totalPages - 1 }, (_, index) => {
    const pageNumber = index + 2;

    return {
      params: { page: String(pageNumber) },
      props: {
        posts: paginatePosts(posts, pageNumber),
        currentPage: pageNumber,
        totalPages,
      },
    };
  });
}

const { posts, currentPage, totalPages } = Astro.props as {
  posts: CollectionEntry<"blog">[];
  currentPage: number;
  totalPages: number;
};
---

<BaseLayout
  title={`Blog â€” Page ${currentPage}`}
  description="Read the latest updates from the Luminux team."
>
  <section class="section-shell flex flex-col gap-8">
    <div class="flex flex-col gap-4">
      <span class="badge w-fit">Blog</span>
      <h1 class="font-display text-4xl font-semibold text-foreground">Notes from the build log</h1>
      <p class="text-lg text-muted max-w-2xl">
        Fresh release notes, tutorials, and product ideas from the Luminux crew.
      </p>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      {posts.map((post) => (
        <article class="card-surface p-6 flex flex-col gap-3" aria-label={post.data.title}>
          <p class="text-xs uppercase tracking-[0.2em] text-aurora">
            {post.data.pubDate.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            })}
          </p>
          <a class="text-xl font-semibold text-foreground" href={`/blog/${post.slug}`}>
            {post.data.title}
          </a>
          <p class="text-muted">{post.data.description}</p>
          <div class="flex flex-wrap gap-2">
            {post.data.tags.map((tag) => (
              <span class="badge">{tag}</span>
            ))}
          </div>
          <a class="button-ghost w-fit" href={`/blog/${post.slug}`}>
            Read post
          </a>
        </article>
      ))}
    </div>

    <nav class="flex flex-col gap-3" aria-label="Blog pagination">
      <p class="text-muted text-sm">Page {currentPage} of {totalPages}</p>
      <div class="flex flex-wrap gap-2">
        {[...Array(totalPages)].map((_, index) => {
          const pageNumber = index + 1;
          const href = pageNumber === 1 ? "/blog" : `/blog/page/${pageNumber}`;

          return (
            <a
              class={`rounded-full border px-4 py-2 text-sm font-semibold transition-colors duration-200 ${
                pageNumber === currentPage
                  ? "bg-aurora text-onAccent border-aurora"
                  : "border-border/40 text-foreground hover:border-aurora/60 hover:text-aurora"
              }`}
              href={href}
            >
              {pageNumber}
            </a>
          );
        })}
      </div>
    </nav>
  </section>
</BaseLayout>
